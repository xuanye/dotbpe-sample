(function(b){b.fn.swapClass=function(b,j){return this.removeClass(b).addClass(j)};b.fn.switchClass=function(b,j){return this.hasClass(b)?this.swapClass(b,j):this.swapClass(j,b)};b.fn.treeview=function(m){function j(a,c,e,h,b){a.isend=b;var f=a.id.replace(/[^\w]/gi,"_");c.push("<li class='bbit-tree-node'>");c.push("<div id='",k,"_",f,"' tpath='",h,"' unselectable='on' title='",a.text,"'");var i=[];i.push("bbit-tree-node-el");a.hasChildren?i.push(a.isexpand?"bbit-tree-node-expanded":"bbit-tree-node-collapsed"):
i.push("bbit-tree-node-leaf");a.classes&&i.push(a.classes);c.push(" class='",i.join(" "),"'>");c.push("<span class='bbit-tree-node-indent'>");if(e==1)c.push("<img class='bbit-tree-icon' src='",d.emptyiconpath,"'/>");else if(e>1){c.push("<img class='bbit-tree-icon' src='",d.emptyiconpath,"'/>");for(var w=1;w<e;w++)c.push("<img class='bbit-tree-elbow-line' src='",d.emptyiconpath,"'/>")}c.push("</span>");i.length=0;a.hasChildren?a.isexpand?i.push(b?"bbit-tree-elbow-end-minus":"bbit-tree-elbow-minus"):
i.push(b?"bbit-tree-elbow-end-plus":"bbit-tree-elbow-plus"):i.push(b?"bbit-tree-elbow-end":"bbit-tree-elbow");c.push("<img class='bbit-tree-ec-icon ",i.join(" "),"' src='",d.emptyiconpath,"'/>");c.push("<img class='bbit-tree-node-icon' src='",d.emptyiconpath,"'/>");if(d.showcheck&&a.showcheck){if(a.checkstate==null||a.checkstate==void 0)a.checkstate=0;c.push("<img  id='",k,"_",f,"_cb' class='bbit-tree-node-cb' src='",d.cbiconpath,d.icons[a.checkstate],"'/>")}c.push("<a hideFocus class='bbit-tree-node-anchor' tabIndex=1 href='javascript:void(0);'>");
c.push("<span unselectable='on'>",a.text,"</span>");c.push("</a>");c.push("</div>");if(a.hasChildren)if(a.isexpand){c.push("<ul  class='bbit-tree-node-ct'  style='z-index: 0; position: static; visibility: visible; top: auto; left: auto;'>");if(a.ChildNodes){b=a.ChildNodes.length;for(f=0;f<b;f++)a.ChildNodes[f].parent=a,j(a.ChildNodes[f],c,e+1,h+"."+f,f==b-1)}c.push("</ul>")}else c.push("<ul style='display:none;'></ul>");c.push("</li>");a.render=!0}function r(a){for(var a=a.split("."),c=g,e=0;e<a.length;e++)c=
e==0?c[a[e]]:c.ChildNodes[a[e]];return c}function A(a,c){p[a.id]=a.path;if(a.id==c[0])return c[2]==1?(o(l,a,c[1]),s(l,a,c[1])):l(a,c[1],1),!1}function l(a,c,e){var h=a.checkstate;if(e==1)a.checkstate=c;else{for(var e=a.ChildNodes,q=e.length,f=!0,i=0;i<q;i++)if(c==1&&e[i].checkstate!=1||c==0&&e[i].checkstate!=0){f=!1;break}a.checkstate=f?c:2}a.render&&h!=a.checkstate&&(c=a.id.replace(/[^\w]/gi,"_"),c=b("#"+k+"_"+c+"_cb"),c.length==1&&c.attr("src",d.cbiconpath+d.icons[a.checkstate]))}function o(a,c,
e){if(a(c,e,1)!=!1&&c.ChildNodes!=null&&c.ChildNodes.length>0)for(var c=c.ChildNodes,b=0,d=c.length;b<d;b++)o(a,c[b],e)}function s(a,c,e){for(c=c.parent;c;){if(a(c,e,0)===!1)break;c=c.parent}}function B(a){var c=b(this).attr("tpath"),a=a.target||a.srcElement,e=r(c);if(a.tagName=="IMG")if(b(a).hasClass("bbit-tree-elbow-plus")||b(a).hasClass("bbit-tree-elbow-end-plus")){var h=b(this).next();if(h.hasClass("bbit-tree-node-ct"))h.show();else{var q=c.split(".").length;e.complete?e.ChildNodes!=null&&x(e.ChildNodes,
q,c,h,e):(b(this).addClass("bbit-tree-node-loading"),t(e,!0,function(a){d.parsedata&&d.parsedata(a);e.complete=!0;e.ChildNodes=a;x(a,q,c,h,e)}))}b(a).hasClass("bbit-tree-elbow-plus")?b(a).swapClass("bbit-tree-elbow-plus","bbit-tree-elbow-minus"):b(a).swapClass("bbit-tree-elbow-end-plus","bbit-tree-elbow-end-minus");b(this).swapClass("bbit-tree-node-collapsed","bbit-tree-node-expanded")}else if(b(a).hasClass("bbit-tree-elbow-minus")||b(a).hasClass("bbit-tree-elbow-end-minus"))b(this).next().hide(),
b(a).hasClass("bbit-tree-elbow-minus")?b(a).swapClass("bbit-tree-elbow-minus","bbit-tree-elbow-plus"):b(a).swapClass("bbit-tree-elbow-end-minus","bbit-tree-elbow-end-plus"),b(this).swapClass("bbit-tree-node-expanded","bbit-tree-node-collapsed");else{if(b(a).hasClass("bbit-tree-node-cb")){var f=e.checkstate!=1?1:0,i=!0;d.oncheckboxclick&&(i=d.oncheckboxclick.call(a,e,f));i!=!1&&(d.cascadecheck?(o(l,e,f),s(l,e,f)):l(e,f,1))}}else if(d.citem&&(a=d.citem.id.replace(/[^\w]/gi,"_"),b("#"+k+"_"+a).removeClass("bbit-tree-selected")),
d.citem=e,b(this).addClass("bbit-tree-selected"),d.onnodeclick){if(!e.expand)e.expand=function(){C.call(e)};d.onnodeclick.call(this,e)}}function C(){var a=this.id.replace(/[^\w]/gi,"_"),a=b("#"+k+"_"+a+" img.bbit-tree-ec-icon");a.length>0&&a.click()}function x(a,c,e,b,d){var f=a.length;if(f>0){for(var i=[],g=0;g<f;g++)a[g].parent=d,j(a[g],i,c,e+"."+g,g==f-1);b.html(i.join(""));u(b)}b.addClass("bbit-tree-node-ct").css({"z-index":0,position:"static",visibility:"visible",top:"auto",left:"auto",display:""});
b.prev().removeClass("bbit-tree-node-loading")}function t(a,c,e){if(d.url){a=a&&a!=null?[{name:"id",value:encodeURIComponent(a.id)},{name:"text",value:encodeURIComponent(a.text)},{name:"value",value:encodeURIComponent(a.value)},{name:"checkstate",value:a.checkstate}]:[];if(d.extParam)for(var h=0;h<d.extParam.length;h++)a[a.length]=d.extParam[h];b.ajax({type:d.method,url:d.url,data:a,async:c,dataType:d.datatype,success:e,error:function(a){alert("error occur:"+a.responseText)}})}}function y(){b(this).hover(function(){b(this).addClass("bbit-tree-node-over")},
function(){b(this).removeClass("bbit-tree-node-over")}).click(B).find("img.bbit-tree-ec-icon").each(function(){b(this).hasClass("bbit-tree-elbow")||b(this).hover(function(){b(this).parent().addClass("bbit-tree-ec-over")},function(){b(this).parent().removeClass("bbit-tree-ec-over")})})}function u(a){b("li.bbit-tree-node>div",a).each(y)}function D(a){var a=a.replace(/[^\w-]/gi,"_"),c=b("#"+k+"_"+a);if(c.length>0){c.addClass("bbit-tree-node-loading");var e=c.hasClass("bbit-tree-elbow-end")||c.hasClass("bbit-tree-elbow-end-plus")||
c.hasClass("bbit-tree-elbow-end-minus"),h=c.attr("tpath"),g=h.split(".").length,f=r(h);f&&t(f,!0,function(a){d.parsedata&&d.parsedata(a);f.complete=!0;f.ChildNodes=a;f.isexpand=!0;f.hasChildren=a&&a.length>0?!0:!1;a=[];j(f,a,g-1,h,e);a.shift();a.pop();var b=c.parent();b.html(a.join(""));u(b);y.call(b.find(">div"))})}else alert("\u8be5\u8282\u70b9\u8fd8\u6ca1\u6709\u751f\u6210")}function v(a,c,b){for(var d=0,g=a.length;d<g;d++)a[d].showcheck==!0&&a[d].checkstate==1&&c.push(b(a[d])),a[d].ChildNodes!=
null&&a[d].ChildNodes.length>0&&v(a[d].ChildNodes,c,b)}function z(a,c,b){for(var d=0,g=a.length;d<g;d++)a[d].showcheck==!0&&(a[d].checkstate==1||a[d].checkstate==2)&&c.push(b(a[d])),a[d].ChildNodes!=null&&a[d].ChildNodes.length>0&&z(a[d].ChildNodes,c,b)}var d={method:"POST",datatype:"json",url:!1,cbiconpath:"/assert/image/icons/",icons:["checkbox_0.gif","checkbox_1.gif","checkbox_2.gif"],emptyiconpath:"/assert/image/icons/s.gif",showcheck:!1,oncheckboxclick:!1,onnodeclick:!1,parsedata:!1,cascadecheck:!0,
data:null,preloadcomplete:!1,clicktoggle:!0,theme:"bbit-tree-arrows"};b.extend(d,m);var g=d.data,p={},m=b(this),k=m.attr("id");if(k==null||k=="")k="bbtree"+(new Date).getTime(),m.attr("id",k);var n=[];(function(a,c){c.push("<div class='bbit-tree-bwrap'>");c.push("<div class='bbit-tree-body'>");c.push("<ul class='bbit-tree-root ",d.theme,"'>");if(a&&a.length>0)for(var b=a.length,h=0;h<b;h++)j(a[h],c,0,h,h==b-1);else t(null,!1,function(a){d.preloadcomplete&&d.preloadcomplete();if(a&&a.length>0){d.parsedata&&
d.parsedata(a);g=a;d.data=a;for(var b=a.length,e=0;e<b;e++)j(a[e],c,0,e,e==b-1)}});c.push("</ul>");c.push("</div>");c.push("</div>")})(d.data,n);m.addClass("bbit-tree").html(n.join(""));u(m);n=null;if(d.showcheck)for(n=0;n<3;n++)(new Image).src=d.cbiconpath+d.icons[n];m[0].t={getSelectedNodes:function(a){var c=[];a?z(g,c,function(a){return a}):v(g,c,function(a){return a});return c},getSelectedValues:function(){var a=[];v(g,a,function(a){return a.value});return a},getCurrentItem:function(){return d.citem},
refresh:function(a){D(typeof a=="string"?a:a.id)},checkAll:function(){if(g!=null&&g.length>0)for(var a=0,c=g.length;a<c;a++)o(l,g[a],1)},unCheckAll:function(){if(g!=null&&g.length>0)for(var a=0,c=g.length;a<c;a++)o(l,g[a],0)},setItemsCheckState:function(a,c,b){if(a!=null&&(a=a.split(","),a.length>0)){var h=d.cascadecheck;b!=null&&typeof b!="undefined"&&(h=b);for(var c=c?1:0,b=0,m=a.length;b<m;b++){var f=a[b],i=c,j=h?1:0;if(p[f])j==1?(o(l,p[f],i),s(l,p[f],i)):l(p[f],i,1);else if(g!=null&&g.length>
0)for(var k=0,n=g.length;k<n;k++)o(A,g[k],[f,i,j])}}},toggle:function(a){a&&(a=a.replace(/[^\w]/gi,"_"),a=b("#"+k+"_"+a+" img.bbit-tree-ec-icon"),a.length>0&&a.click())},getTreeData:function(){return d.data}};return m};b.fn.getTSVs=function(){return this[0].t?this[0].t.getSelectedValues():null};b.fn.getTSNs=function(b){return this[0].t?this[0].t.getSelectedNodes(b):null};b.fn.getTCT=function(){return this[0].t?this[0].t.getCurrentItem():null};b.fn.refresh=function(b){if(this[0].t)return this[0].t.refresh(b)};
b.fn.checkAll=function(){if(this[0].t)return this[0].t.checkAll()};b.fn.unCheckAll=function(){if(this[0].t)return this[0].t.unCheckAll()};b.fn.setItemsCheckState=function(b,j,r){if(this[0].t)return this[0].t.setItemsCheckState(b,j,r)};b.fn.toggleItem=function(b){if(this[0].t)return this[0].t.toggle(b)};b.fn.getTreeData=function(){if(this[0].t)return this[0].t.getTreeData()}})(jQuery);
